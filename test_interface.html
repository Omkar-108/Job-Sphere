<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assessment Test - JobSphere</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <style>
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .question-card {
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f8f9fa;
        }
        .option-label {
            display: block;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .option-label:hover {
            background: #e9ecef;
        }
        .option-label.selected {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        .timer {
            font-size: 1.2em;
            font-weight: bold;
            color: #dc3545;
        }
        .progress-bar-container {
            position: sticky;
            top: 0;
            background: white;
            z-index: 1000;
            padding: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-instructions {
            background: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin-bottom: 20px;
        }
        .question-navigation {
            position: fixed;
            right: 20px;
            top: 100px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-height: 70vh;
            overflow-y: auto;
        }
        .nav-item {
            display: inline-block;
            width: 40px;
            height: 40px;
            line-height: 40px;
            text-align: center;
            margin: 2px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .nav-item:hover {
            background: #e9ecef;
        }
        .nav-item.answered {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }
        .nav-item.current {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        .test-completed {
            text-align: center;
            padding: 50px;
        }
        .score-display {
            font-size: 3em;
            font-weight: bold;
            color: #28a745;
        }
        @media (max-width: 768px) {
            .question-navigation {
                position: static;
                margin-top: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('main.index') }}">
                <i class="fas fa-briefcase me-2"></i>JobSphere
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('user.dashboard_user') }}">
                    <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </nav>

    <!-- Test Container -->
    <div class="container-fluid mt-4">
        <div class="test-container">
            <!-- Test Header -->
            <div class="progress-bar-container">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h4 id="testTitle">Loading Test...</h4>
                        <p class="mb-0" id="testDescription"></p>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <small class="text-muted">Time Remaining</small>
                            <div class="timer" id="timer">--:--</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="progress">
                            <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted">Question <span id="currentQuestion">1</span> of <span id="totalQuestions">1</span></small>
                    </div>
                </div>
            </div>

            <!-- Test Instructions -->
            <div class="test-instructions" id="instructions">
                <h5><i class="fas fa-info-circle me-2"></i>Test Instructions</h5>
                <ul>
                    <li>Read each question carefully before answering</li>
                    <li>Select one answer for each multiple-choice question</li>
                    <li>You can navigate between questions using the navigation panel</li>
                    <li>Make sure to submit your test before time expires</li>
                    <li>Once submitted, you cannot change your answers</li>
                </ul>
                <button class="btn btn-primary" onclick="startTest()">
                    <i class="fas fa-play me-1"></i>Start Test
                </button>
            </div>

            <!-- Questions Container -->
            <div id="questionsContainer" style="display: none;">
                <!-- Questions will be loaded here -->
            </div>

            <!-- Test Completed Screen -->
            <div id="testCompleted" class="test-completed" style="display: none;">
                <i class="fas fa-check-circle text-success" style="font-size: 4em;"></i>
                <h3>Test Submitted Successfully!</h3>
                <p>Your test has been submitted and is being evaluated.</p>
                <div class="score-display" id="scoreDisplay">--</div>
                <p id="resultMessage"></p>
                <button class="btn btn-primary" onclick="goToDashboard()">
                    <i class="fas fa-home me-1"></i>Back to Dashboard
                </button>
            </div>

            <!-- Question Navigation -->
            <div class="question-navigation" id="questionNavigation" style="display: none;">
                <h6>Question Navigation</h6>
                <div id="navigationItems">
                    <!-- Navigation items will be generated here -->
                </div>
                <div class="mt-3">
                    <button class="btn btn-success btn-sm w-100" onclick="submitTest()" id="submitBtn">
                        <i class="fas fa-paper-plane me-1"></i>Submit Test
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let testData = {};
        let currentQuestionIndex = 0;
        let answers = {};
        let timerInterval;
        let timeRemaining = 0;

        // Load test data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadTestData();
        });

        async function loadTestData() {
            try {
                const testId = getTestIdFromUrl();
                const applicationId = getApplicationIdFromUrl();
                
                if (!testId || !applicationId) {
                    showError('Test ID or Application ID missing');
                    return;
                }

                // Start test submission
                const response = await fetch(`/api/scheduler/tests/${testId}/submissions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        application_id: applicationId
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    // Get test details with questions
                    const testResponse = await fetch(`/api/scheduler/tests/${testId}`);
                    const testResult = await testResponse.json();
                    
                    if (testResult.success) {
                        testData = testResult.test;
                        displayTestInfo();
                    } else {
                        showError('Failed to load test questions');
                    }
                } else {
                    showError('Failed to start test');
                }
            } catch (error) {
                console.error('Error loading test:', error);
                showError('Error loading test');
            }
        }

        function displayTestInfo() {
            document.getElementById('testTitle').textContent = testData.title;
            document.getElementById('testDescription').textContent = testData.description;
            document.getElementById('totalQuestions').textContent = testData.questions.length;
            
            // Calculate time in seconds
            timeRemaining = testData.duration_minutes * 60;
        }

        function startTest() {
            document.getElementById('instructions').style.display = 'none';
            document.getElementById('questionsContainer').style.display = 'block';
            document.getElementById('questionNavigation').style.display = 'block';
            
            generateNavigation();
            displayQuestion(0);
            startTimer();
        }

        function generateNavigation() {
            const navContainer = document.getElementById('navigationItems');
            navContainer.innerHTML = '';
            
            for (let i = 0; i < testData.questions.length; i++) {
                const navItem = document.createElement('div');
                navItem.className = 'nav-item';
                navItem.textContent = i + 1;
                navItem.onclick = () => goToQuestion(i);
                navItem.id = `nav-item-${i}`;
                navContainer.appendChild(navItem);
            }
            
            updateNavigation();
        }

        function displayQuestion(index) {
            if (index < 0 || index >= testData.questions.length) return;
            
            currentQuestionIndex = index;
            const question = testData.questions[index];
            
            const questionsHtml = `
                <div class="question-card">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h5>Question ${index + 1}</h5>
                        <span class="badge bg-secondary">${question.difficulty}</span>
                    </div>
                    <p class="mb-3">${question.question_text}</p>
                    <div class="options">
                        ${question.options.map((option, optIndex) => `
                            <label class="option-label ${answers[question._id] === String.fromCharCode(65 + optIndex) ? 'selected' : ''}">
                                <input type="radio" 
                                       name="question_${question._id}" 
                                       value="${String.fromCharCode(65 + optIndex)}"
                                       ${answers[question._id] === String.fromCharCode(65 + optIndex) ? 'checked' : ''}
                                       onchange="selectAnswer('${question._id}', '${String.fromCharCode(65 + optIndex)}')">
                                <span class="ms-2">${String.fromCharCode(65 + optIndex)}. ${option}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('questionsContainer').innerHTML = questionsHtml;
            updateProgress();
            updateNavigation();
        }

        function selectAnswer(questionId, answer) {
            answers[questionId] = answer;
            
            // Update selected state
            document.querySelectorAll('.option-label').forEach(label => {
                label.classList.remove('selected');
            });
            
            event.target.closest('.option-label').classList.add('selected');
            updateNavigation();
        }

        function goToQuestion(index) {
            displayQuestion(index);
        }

        function nextQuestion() {
            if (currentQuestionIndex < testData.questions.length - 1) {
                displayQuestion(currentQuestionIndex + 1);
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                displayQuestion(currentQuestionIndex - 1);
            }
        }

        function updateProgress() {
            const progress = ((currentQuestionIndex + 1) / testData.questions.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
        }

        function updateNavigation() {
            // Update current question highlight
            document.querySelectorAll('.nav-item').forEach((item, index) => {
                item.classList.remove('current');
                if (index === currentQuestionIndex) {
                    item.classList.add('current');
                }
            });
            
            // Update answered questions
            Object.keys(answers).forEach(questionId => {
                const questionIndex = testData.questions.findIndex(q => q._id === questionId);
                if (questionIndex !== -1) {
                    document.getElementById(`nav-item-${questionIndex}`).classList.add('answered');
                }
            });
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    submitTest();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Change color when time is running out
            if (timeRemaining < 300) { // Less than 5 minutes
                document.getElementById('timer').style.color = '#dc3545';
            } else if (timeRemaining < 600) { // Less than 10 minutes
                document.getElementById('timer').style.color = '#ffc107';
            }
        }

        async function submitTest() {
            if (!confirm('Are you sure you want to submit your test? You cannot change your answers after submission.')) {
                return;
            }

            clearInterval(timerInterval);
            
            try {
                const submissionId = getSubmissionId();
                const response = await fetch(`/api/scheduler/test-submissions/${submissionId}/submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        answers: answers
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    displayResults(result.results);
                } else {
                    showError('Failed to submit test');
                }
            } catch (error) {
                console.error('Error submitting test:', error);
                showError('Error submitting test');
            }
        }

        function displayResults(results) {
            document.getElementById('questionsContainer').style.display = 'none';
            document.getElementById('questionNavigation').style.display = 'none';
            document.getElementById('testCompleted').style.display = 'block';
            
            const percentage = results.percentage || 0;
            document.getElementById('scoreDisplay').textContent = `${percentage.toFixed(1)}%`;
            
            let message = '';
            if (percentage >= 80) {
                message = 'Excellent work! You have passed the test with flying colors.';
            } else if (percentage >= 70) {
                message = 'Good job! You have passed the test.';
            } else {
                message = 'Thank you for completing the test. Your results will be reviewed by the hiring team.';
            }
            
            document.getElementById('resultMessage').textContent = message;
        }

        function goToDashboard() {
            window.location.href = '/dashboard/user';
        }

        function showError(message) {
            document.getElementById('testTitle').textContent = 'Error';
            document.getElementById('instructions').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>${message}
                </div>
                <button class="btn btn-primary" onclick="goToDashboard()">
                    <i class="fas fa-home me-1"></i>Back to Dashboard
                </button>
            `;
        }

        function getTestIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('test_id');
        }

        function getApplicationIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('application_id');
        }

        function getSubmissionId() {
            // This should be stored when starting the test
            return sessionStorage.getItem('submissionId') || '';
        }

        // Handle page unload
        window.addEventListener('beforeunload', function(e) {
            if (document.getElementById('questionsContainer').style.display !== 'none') {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>