<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Dashboard â€“ Job Sphere</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            color: white;
        }
        .application-card {
            transition: all 0.3s ease;
            border-left: 4px solid #667eea;
        }
        .application-card:hover {
            transform: translateX(5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-pending { background-color: #f59e0b; }
        .status-interview { background-color: #3b82f6; }
        .status-hired { background-color: #10b981; }
        .status-rejected { background-color: #ef4444; }
    </style>
</head>
<body>
    <!-- Enhanced Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="{{ url_for('main.index') }}">
                <i class="bi bi-hexagon-fill me-2"></i>Job Sphere
            </a>
            <div class="navbar-nav ms-auto">
                {% if user_email %}
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" data-bs-toggle="dropdown">
                        <div class="profile-circle me-2 bg-white text-primary rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 35px; height: 35px; font-weight: bold;">
                            {{ user_email[0] | upper }}
                        </div>
                        <span class="text-white">{{ user_email.split('@')[0] }}</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="{{ url_for('user.dashboard_user') }}">
                            <i class="bi bi-speedometer2 me-2"></i>Dashboard
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="loadSchedulerDashboard()">
                            <i class="bi bi-calendar-check me-2"></i>Interviews & Tests
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="showMyTests()">
                            <i class="bi bi-clipboard-check me-2"></i>My Tests
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="{{ url_for('auth.logout') }}">
                            <i class="bi bi-box-arrow-right me-2"></i>Logout
                        </a></li>
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- Dashboard Content -->
    <div class="container my-4">
        <!-- Welcome Header -->
        <div class="dashboard-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-6 fw-bold mb-2">Welcome back!</h1>
                    <p class="mb-0 opacity-75">Track your job applications and interviews in one place</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <a href="{{ url_for('main.jobs_page') }}" class="btn btn-light rounded-pill px-4">
                        <i class="bi bi-plus-circle me-2"></i>Apply for Jobs
                    </a>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-5">
            <div class="col-md-4 mb-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center">
                            <div class="bg-primary bg-opacity-10 rounded-circle p-3 me-3">
                                <i class="bi bi-file-text text-primary fs-4"></i>
                            </div>
                            <div>
                                <h6 class="text-muted mb-1">Total Applications</h6>
                                <h2 class="text-primary mb-0">{{ applications|length }}</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center">
                            <div class="bg-warning bg-opacity-10 rounded-circle p-3 me-3">
                                <i class="bi bi-calendar-check text-warning fs-4"></i>
                            </div>
                            <div>
                                <h6 class="text-muted mb-1">Interviews</h6>
                                <h2 class="text-warning mb-0">
                                    {{ applications | selectattr("status", "equalto", "Interview Scheduled") | list | length }}
                                </h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center">
                            <div class="bg-success bg-opacity-10 rounded-circle p-3 me-3">
                                <i class="bi bi-award text-success fs-4"></i>
                            </div>
                            <div>
                                <h6 class="text-muted mb-1">Hired</h6>
                                <h2 class="text-success mb-0">
                                    {{ applications | selectattr("status", "equalto", "Hired") | list | length }}
                                </h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Applications Table -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="card-title mb-0">Your Applications</h5>
                <p class="text-muted small mb-0">Track the status of all your job applications</p>
            </div>
            <div class="card-body">
                {% if applications_with_jobs %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Position</th>
                                <th>Department</th>
                                <th>Status</th>
                                <th>Resume</th>
                                <th>Test</th>
                                <th>Interview</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for app, job in applications_with_jobs %}
                            <tr class="application-card">
                                <td>
                                    <div class="fw-semibold">{{ job.title }}</div>
                                    <small class="text-muted">Applied {{ app.date_applied if app.date_applied else 'Recently' }}</small>
                                </td>
                                <td>
                                    <span class="badge bg-primary bg-opacity-10 text-primary">
                                        {{ job.department }}
                                    </span>
                                </td>
                                <td>
                                    {% if app.status == 'Hired' %}
                                    <span class="badge bg-success bg-opacity-10 text-success border border-success">
                                        <span class="status-indicator status-hired"></span>
                                        {{ app.status }}
                                    </span>
                                    {% elif app.status == 'Interview Scheduled' %}
                                    <span class="badge bg-primary bg-opacity-10 text-primary border border-primary">
                                        <span class="status-indicator status-interview"></span>
                                        {{ app.status }}
                                    </span>
                                    {% elif app.status == 'Under Review' %}
                                    <span class="badge bg-info bg-opacity-10 text-info border border-info">
                                        <span class="status-indicator status-pending"></span>
                                        {{ app.status }}
                                    </span>
                                    {% elif app.status == 'Rejected' %}
                                    <span class="badge bg-danger bg-opacity-10 text-danger border border-danger">
                                        <span class="status-indicator status-rejected"></span>
                                        {{ app.status }}
                                    </span>
                                    {% else %}
                                    <span class="badge bg-warning bg-opacity-10 text-warning border border-warning">
                                        <span class="status-indicator status-pending"></span>
                                        {{ app.status }}
                                    </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if app.resume_file %}
                                    <div class="btn-group" role="group">
                                        <a href="{{ url_for('view_resume', filename=app.resume_file) }}"
                                           class="btn btn-sm btn-outline-primary" target="_blank">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a href="{{ url_for('download_resume', filename=app.resume_file) }}"
                                           class="btn btn-sm btn-outline-secondary">
                                            <i class="bi bi-download"></i>
                                        </a>
                                    </div>
                                    {% else %}
                                    <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if app.status == 'Test Required' or app.status == 'Test In Progress' %}
                                    <button class="btn btn-sm btn-primary" onclick="takeTest('{{ app._id }}')">
                                        <i class="bi bi-pencil-square me-1"></i>Take Test
                                    </button>
                                    {% elif app.status == 'Test Completed' %}
                                    <button class="btn btn-sm btn-outline-info" onclick="viewTestResults('{{ app._id }}')">
                                        <i class="bi bi-bar-chart me-1"></i>Results
                                    </button>
                                    {% else %}
                                    <span class="text-muted small">Not Available</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if app.status == 'Interview Scheduled' %}
                                    <a href="{{ url_for('user.video_call_user', app_id=app._id) }}"
                                       class="btn btn-sm btn-success">
                                        <i class="bi bi-camera-video me-1"></i>Join Call
                                    </a>
                                    {% else %}
                                    <span class="text-muted small">Not Available</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="bi bi-file-text text-muted" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="text-muted mb-3">No applications yet</h5>
                    <p class="text-muted mb-4">Start your job search and apply for positions</p>
                    <a href="{{ url_for('main.jobs_page') }}" class="btn btn-primary px-4">
                        <i class="bi bi-search me-2"></i>Browse Jobs
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- My Tests Section -->
        <div class="card border-0 shadow-sm mt-4" id="myTestsSection" style="display: none;">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="card-title mb-0">My Tests</h5>
                <p class="text-muted small mb-0">View your test history and results</p>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="myTestsTable">
                        <thead>
                            <tr>
                                <th>Test Title</th>
                                <th>Job Position</th>
                                <th>Status</th>
                                <th>Score</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Tests will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Taking Modal -->
    <div class="modal fade" id="testTakingModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Assessment Test</h5>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-warning me-3" id="timerDisplay">Time Remaining: 60:00</span>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <div id="testContent">
                        <!-- Test questions will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="submitTest()">Submit Test</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Results Modal -->
    <div class="modal fade" id="testResultsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Test Results</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="testResultsContent">
                        <!-- Test results will be displayed here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container text-center">
            <p>&copy; 2024 Job Sphere. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/chatbot.js') }}"></script>
    <script>
        function loadSchedulerDashboard() {
            // Load candidate scheduler dashboard
            window.location.href = '/api/scheduler/dashboard/candidate/{{ user_id }}';
        }
        
        // Load candidate dashboard data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadCandidateDashboard();
        });
        
        async function loadCandidateDashboard() {
            try {
                const response = await fetch(`/api/scheduler/dashboard/candidate/{{ user_id }}`);
                const data = await response.json();
                
                if (data.success) {
                    updateCandidateUI(data.dashboard);
                }
            } catch (error) {
                console.error('Error loading candidate dashboard:', error);
            }
        }
        
        function updateCandidateUI(dashboard) {
            // Update application counts with scheduler info
            const summary = dashboard.summary;
            
            // Update status indicators if elements exist
            const pendingElements = document.querySelectorAll('.status-pending');
            const interviewElements = document.querySelectorAll('.status-interview');
            
            // Add scheduler information to application cards
            const applicationCards = document.querySelectorAll('.application-card');
            applicationCards.forEach((card, index) => {
                // Add upcoming interviews or tests info
                if (summary.upcoming_interviews > 0) {
                    const badge = document.createElement('span');
                    badge.className = 'badge bg-info ms-2';
                    badge.textContent = `${summary.upcoming_interviews} Interview(s)`;
                    card.querySelector('.card-header').appendChild(badge);
                }
            });
        }
    </script>

    <script>
        let currentTest = null;
        let testTimer = null;
        let timeRemaining = 0;

        // Test Management Functions
        async function showMyTests() {
            const testsSection = document.getElementById('myTestsSection');
            testsSection.style.display = testsSection.style.display === 'none' ? 'block' : 'none';
            
            if (testsSection.style.display === 'block') {
                await loadMyTests();
            }
        }

        async function loadMyTests() {
            try {
                const response = await fetch(`/api/scheduler/dashboard/candidate/{{ user_id }}`);
                const data = await response.json();
                
                if (data.success) {
                    const testHistory = data.dashboard.test_history;
                    const testsTable = document.getElementById('myTestsTable').getElementsByTagName('tbody')[0];
                    testsTable.innerHTML = '';
                    
                    testHistory.forEach(test => {
                        const row = testsTable.insertRow();
                        const status = test.status || 'Completed';
                        const score = test.percentage ? `${test.percentage.toFixed(1)}%` : 'N/A';
                        const date = test.completed_at ? new Date(test.completed_at).toLocaleDateString() : 'N/A';
                        
                        row.innerHTML = `
                            <td>${test.test?.title || 'N/A'}</td>
                            <td>${test.application?.job_title || 'N/A'}</td>
                            <td><span class="badge bg-${status === 'Evaluated' ? 'success' : 'warning'}">${status}</span></td>
                            <td>${score}</td>
                            <td>${date}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-info" onclick="viewDetailedTestResults('${test._id}')">
                                    <i class="bi bi-eye"></i> View Details
                                </button>
                            </td>
                        `;
                    });
                }
            } catch (error) {
                console.error('Error loading tests:', error);
            }
        }

        async function takeTest(applicationId) {
            try {
                // First, get the test for this application
                const response = await fetch(`/api/scheduler/tests/for-application/${applicationId}`);
                const data = await response.json();
                
                if (data.success && data.test) {
                    currentTest = data.test;
                    
                    // Start test submission
                    const startResponse = await fetch(`/api/scheduler/tests/${data.test._id}/submissions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            application_id: applicationId
                        })
                    });
                    
                    const startData = await startResponse.json();
                    
                    if (startData.success) {
                        currentTest.submission_id = startData.submission_id;
                        await loadTestQuestions();
                        startTestTimer();
                        bootstrap.Modal.getOrCreateInstance(document.getElementById('testTakingModal')).show();
                    } else {
                        alert('Error starting test: ' + startData.error);
                    }
                } else {
                    alert('No test available for this application');
                }
            } catch (error) {
                console.error('Error taking test:', error);
                alert('Error starting test');
            }
        }

        async function loadTestQuestions() {
            const testContent = document.getElementById('testContent');
            let questionsHtml = `<div class="mb-3"><h6>${currentTest.title}</h6><p class="text-muted">${currentTest.description}</p></div>`;
            
            currentTest.questions.forEach((question, index) => {
                questionsHtml += `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6>Question ${index + 1}</h6>
                            <p class="mb-3">${question.question_text}</p>
                            <div class="options">
                                ${question.options.map((option, optIndex) => `
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="question_${question._id}"
                                               id="option_${question._id}_${optIndex}" value="${String.fromCharCode(65 + optIndex)}">
                                        <label class="form-check-label" for="option_${question._id}_${optIndex}">
                                            ${option}
                                        </label>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            testContent.innerHTML = questionsHtml;
        }

        function startTestTimer() {
            timeRemaining = currentTest.duration_minutes * 60;
            
            testTimer = setInterval(() => {
                timeRemaining--;
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                document.getElementById('timerDisplay').textContent =
                    `Time Remaining: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeRemaining <= 0) {
                    clearInterval(testTimer);
                    submitTest();
                }
            }, 1000);
        }

        async function submitTest() {
            if (testTimer) {
                clearInterval(testTimer);
            }
            
            const answers = {};
            currentTest.questions.forEach(question => {
                const selectedOption = document.querySelector(`input[name="question_${question._id}"]:checked`);
                if (selectedOption) {
                    answers[question._id] = selectedOption.value;
                }
            });
            
            try {
                const response = await fetch(`/api/scheduler/test-submissions/${currentTest.submission_id}/submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        answers: answers
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Test submitted successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('testTakingModal')).hide();
                    await loadMyTests();
                    // Refresh the page to update application status
                    window.location.reload();
                } else {
                    alert('Error submitting test: ' + data.error);
                }
            } catch (error) {
                console.error('Error submitting test:', error);
                alert('Error submitting test');
            }
        }

        async function viewTestResults(applicationId) {
            try {
                const response = await fetch(`/api/scheduler/test-results/application/${applicationId}`);
                const data = await response.json();
                
                if (data.success && data.results) {
                    displayTestResults(data.results);
                    bootstrap.Modal.getOrCreateInstance(document.getElementById('testResultsModal')).show();
                } else {
                    alert('No test results available');
                }
            } catch (error) {
                console.error('Error viewing test results:', error);
            }
        }

        async function viewDetailedTestResults(submissionId) {
            try {
                const response = await fetch(`/api/scheduler/test-submissions/${submissionId}/results`);
                const data = await response.json();
                
                if (data.success && data.results) {
                    displayTestResults(data.results);
                    bootstrap.Modal.getOrCreateInstance(document.getElementById('testResultsModal')).show();
                } else {
                    alert('No test results available');
                }
            } catch (error) {
                console.error('Error viewing test results:', error);
            }
        }

        function displayTestResults(results) {
            const resultsContent = document.getElementById('testResultsContent');
            const percentage = results.percentage || 0;
            const passed = results.passed || false;
            
            let resultsHtml = `
                <div class="text-center mb-4">
                    <h4>Test Results</h4>
                    <div class="display-4 text-${passed ? 'success' : 'danger'}">${percentage.toFixed(1)}%</div>
                    <p class="lead">${passed ? 'PASSED' : 'FAILED'}</p>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <h6>Score Details</h6>
                        <p><strong>Score:</strong> ${results.score || 0} / ${results.total_points || 0}</p>
                        <p><strong>Percentage:</strong> ${percentage.toFixed(1)}%</p>
                        <p><strong>Status:</strong> <span class="badge bg-${passed ? 'success' : 'danger'}">${passed ? 'Passed' : 'Failed'}</span></p>
                    </div>
                    <div class="col-md-6">
                        <h6>Test Information</h6>
                        <p><strong>Test:</strong> ${results.test?.title || 'N/A'}</p>
                        <p><strong>Completed:</strong> ${results.submission?.completed_at ? new Date(results.submission.completed_at).toLocaleDateString() : 'N/A'}</p>
                    </div>
                </div>
            `;
            
            if (results.questions && results.questions.length > 0) {
                resultsHtml += `
                    <h6 class="mt-4">Question Review</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Question</th>
                                    <th>Your Answer</th>
                                    <th>Correct Answer</th>
                                    <th>Result</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                results.questions.forEach(question => {
                    const isCorrect = question.correct_answer === question.candidate_answer;
                    resultsHtml += `
                        <tr>
                            <td>${question.question_text.substring(0, 100)}...</td>
                            <td>${question.candidate_answer || 'Not answered'}</td>
                            <td>${question.correct_answer}</td>
                            <td><span class="badge bg-${isCorrect ? 'success' : 'danger'}">${isCorrect ? 'Correct' : 'Incorrect'}</span></td>
                        </tr>
                    `;
                });
                
                resultsHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            resultsContent.innerHTML = resultsHtml;
        }
    </script>
</body>
</html>